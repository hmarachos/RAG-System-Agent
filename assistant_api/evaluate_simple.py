"""
–ü—Ä–æ—Å—Ç–∞—è –æ—Ü–µ–Ω–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞ RAG —Å–∏—Å—Ç–µ–º—ã –±–µ–∑ PyTorch –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π.
–ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç–æ–ª—å–∫–æ OpenAI API –¥–ª—è –æ—Ü–µ–Ω–∫–∏ –∫–∞—á–µ—Å—Ç–≤–∞ –æ—Ç–≤–µ—Ç–æ–≤ —Å —ç—Ç–∞–ª–æ–Ω–Ω—ã–º–∏ –æ—Ç–≤–µ—Ç–∞–º–∏.
"""

import os
import sys
import json
from pathlib import Path
from dotenv import load_dotenv
from typing import Dict, List, Any
from openai import OpenAI

# –ó–∞–≥—Ä—É–∑–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
env_path = Path(__file__).parent.parent / '.env'
if env_path.exists():
    load_dotenv(env_path)
else:
    load_dotenv()

from rag_pipeline import RAGPipeline


# –¢–µ—Å—Ç–æ–≤—ã–µ –≤–æ–ø—Ä–æ—Å—ã –¥–ª—è –æ—Ü–µ–Ω–∫–∏ RAG —Å–∏—Å—Ç–µ–º—ã
EVALUATION_QUESTIONS = [
    "–ß—Ç–æ —Ç–∞–∫–æ–µ –º–∞—à–∏–Ω–Ω–æ–µ –æ–±—É—á–µ–Ω–∏–µ?",
    "–ö–∞–∫–∏–µ –æ—Å–Ω–æ–≤–Ω—ã–µ —Ç–∏–ø—ã –º–∞—à–∏–Ω–Ω–æ–≥–æ –æ–±—É—á–µ–Ω–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—Ç?", 
    "–ß—Ç–æ —Ç–∞–∫–æ–µ –Ω–µ–π—Ä–æ–Ω–Ω–∞—è —Å–µ—Ç—å?",
    "–ö–∞–∫ —Ä–∞–±–æ—Ç–∞—é—Ç —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–µ—Ä—ã –≤ NLP?",
    "–ß—Ç–æ —Ç–∞–∫–æ–µ RAG –∏ –∫–∞–∫ –æ–Ω —Ä–∞–±–æ—Ç–∞–µ—Ç?",
    "–ß—Ç–æ —Ç–∞–∫–æ–µ –≤–µ–∫—Ç–æ—Ä–Ω—ã–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è —Å–ª–æ–≤?",
    "–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ AI —Å–∏—Å—Ç–µ–º–∞—Ö?",
    "–ß—Ç–æ —Ç–∞–∫–æ–µ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –≤ —è–∑—ã–∫–æ–≤—ã—Ö –º–æ–¥–µ–ª—è—Ö?"
]


def get_ground_truth_answers() -> dict:
    """
    –≠—Ç–∞–ª–æ–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ data/docs.txt.
    
    Returns:
        —Å–ª–æ–≤–∞—Ä—å —Å —ç—Ç–∞–ª–æ–Ω–Ω—ã–º–∏ –æ—Ç–≤–µ—Ç–∞–º–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞
    """
    ground_truth = {
        "–ß—Ç–æ —Ç–∞–∫–æ–µ –º–∞—à–∏–Ω–Ω–æ–µ –æ–±—É—á–µ–Ω–∏–µ?": 
            "–ú–∞—à–∏–Ω–Ω–æ–µ –æ–±—É—á–µ–Ω–∏–µ - —ç—Ç–æ —Ä–∞–∑–¥–µ–ª –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç–∞, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–∑–≤–æ–ª—è–µ—Ç –∫–æ–º–ø—å—é—Ç–µ—Ä–∞–º –æ–±—É—á–∞—Ç—å—Å—è –Ω–∞ –¥–∞–Ω–Ω—ã—Ö –±–µ–∑ —è–≤–Ω–æ–≥–æ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è.",
        
        "–ö–∞–∫–∏–µ –æ—Å–Ω–æ–≤–Ω—ã–µ —Ç–∏–ø—ã –º–∞—à–∏–Ω–Ω–æ–≥–æ –æ–±—É—á–µ–Ω–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—Ç?":
            "–û—Å–Ω–æ–≤–Ω—ã–µ —Ç–∏–ø—ã –º–∞—à–∏–Ω–Ω–æ–≥–æ –æ–±—É—á–µ–Ω–∏—è –≤–∫–ª—é—á–∞—é—Ç –æ–±—É—á–µ–Ω–∏–µ —Å —É—á–∏—Ç–µ–ª–µ–º, –æ–±—É—á–µ–Ω–∏–µ –±–µ–∑ —É—á–∏—Ç–µ–ª—è –∏ –æ–±—É—á–µ–Ω–∏–µ —Å –ø–æ–¥–∫—Ä–µ–ø–ª–µ–Ω–∏–µ–º. –û–±—É—á–µ–Ω–∏–µ —Å —É—á–∏—Ç–µ–ª–µ–º –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ä–∞–∑–º–µ—á–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤.",
        
        "–ß—Ç–æ —Ç–∞–∫–æ–µ –Ω–µ–π—Ä–æ–Ω–Ω–∞—è —Å–µ—Ç—å?":
            "–ù–µ–π—Ä–æ–Ω–Ω—ã–µ —Å–µ—Ç–∏ - —ç—Ç–æ –º–æ–¥–µ–ª–∏ –º–∞—à–∏–Ω–Ω–æ–≥–æ –æ–±—É—á–µ–Ω–∏—è, –≤–¥–æ—Ö–Ω–æ–≤–ª—ë–Ω–Ω—ã–µ —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π —á–µ–ª–æ–≤–µ—á–µ—Å–∫–æ–≥–æ –º–æ–∑–≥–∞. –û–Ω–∏ —Å–æ—Å—Ç–æ—è—Ç –∏–∑ —Å–ª–æ—ë–≤ –≤–∑–∞–∏–º–æ—Å–≤—è–∑–∞–Ω–Ω—ã—Ö –Ω–µ–π—Ä–æ–Ω–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é. –ì–ª—É–±–æ–∫–∏–µ –Ω–µ–π—Ä–æ–Ω–Ω—ã–µ —Å–µ—Ç–∏ —Å–æ–¥–µ—Ä–∂–∞—Ç –º–Ω–æ–∂–µ—Å—Ç–≤–æ —Å–∫—Ä—ã—Ç—ã—Ö —Å–ª–æ—ë–≤ –∏ —Å–ø–æ—Å–æ–±–Ω—ã –æ–±—É—á–∞—Ç—å—Å—è —Å–ª–æ–∂–Ω—ã–º –ø–∞—Ç—Ç–µ—Ä–Ω–∞–º.",
        
        "–ö–∞–∫ —Ä–∞–±–æ—Ç–∞—é—Ç —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–µ—Ä—ã –≤ NLP?":
            "–¢—Ä–∞–Ω—Å—Ñ–æ—Ä–º–µ—Ä—ã - —ç—Ç–æ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –Ω–µ–π—Ä–æ–Ω–Ω—ã—Ö —Å–µ—Ç–µ–π, –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–Ω–∞—è –≤ —Å—Ç–∞—Ç—å–µ 'Attention is All You Need' –≤ 2017 –≥–æ–¥—É. –û–Ω–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç –º–µ—Ö–∞–Ω–∏–∑–º —Å–∞–º–æ–≤–Ω–∏–º–∞–Ω–∏—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–µ–π –¥–∞–Ω–Ω—ã—Ö. –¢—Ä–∞–Ω—Å—Ñ–æ—Ä–º–µ—Ä—ã —Å—Ç–∞–ª–∏ –æ—Å–Ω–æ–≤–æ–π –¥–ª—è –º–æ–¥–µ–ª–µ–π —Ç–∏–ø–∞ BERT, GPT –∏ T5 –∏ –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ –ø—Ä–µ–≤–æ—Å—Ö–æ–¥—è—Ç –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã –≤ –∑–∞–¥–∞—á–∞—Ö NLP.",
        
        "–ß—Ç–æ —Ç–∞–∫–æ–µ RAG –∏ –∫–∞–∫ –æ–Ω —Ä–∞–±–æ—Ç–∞–µ—Ç?":
            "RAG (Retrieval-Augmented Generation) - —ç—Ç–æ –ø–æ–¥—Ö–æ–¥, –∫–æ—Ç–æ—Ä—ã–π –∫–æ–º–±–∏–Ω–∏—Ä—É–µ—Ç –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –∏–∑ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π —Å –≥–µ–Ω–µ—Ä–∞—Ü–∏–µ–π —Ç–µ–∫—Å—Ç–∞ —è–∑—ã–∫–æ–≤—ã–º–∏ –º–æ–¥–µ–ª—è–º–∏. RAG —Å–∏—Å—Ç–µ–º—ã —Å–Ω–∞—á–∞–ª–∞ –Ω–∞—Ö–æ–¥—è—Ç —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã, –∑–∞—Ç–µ–º –∏—Å–ø–æ–ª—å–∑—É—é—Ç –∏—Ö –∫–∞–∫ –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–∞. –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –º–æ–¥–µ–ª—è–º –æ—Ç–≤–µ—á–∞—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ –∞–∫—Ç—É–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ –æ–±—É—á–µ–Ω–∏—è.",
        
        "–ß—Ç–æ —Ç–∞–∫–æ–µ –≤–µ–∫—Ç–æ—Ä–Ω—ã–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è —Å–ª–æ–≤?":
            "–í–µ–∫—Ç–æ—Ä–Ω—ã–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è —Å–ª–æ–≤ (embeddings) - —ç—Ç–æ —Å–ø–æ—Å–æ–± –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è —Å–ª–æ–≤ –≤ –≤–∏–¥–µ –ø–ª–æ—Ç–Ω—ã—Ö –≤–µ–∫—Ç–æ—Ä–æ–≤ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Ä–∞–∑–º–µ—Ä–Ω–æ—Å—Ç–∏. Word2Vec –∏ GloVe –±—ã–ª–∏ —Ä–∞–Ω–Ω–∏–º–∏ –º–µ—Ç–æ–¥–∞–º–∏ —Å–æ–∑–¥–∞–Ω–∏—è embeddings. –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –º–æ–¥–µ–ª–∏ —Å–æ–∑–¥–∞—é—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç—É–∞–ª—å–Ω—ã–µ embeddings, –≥–¥–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ —Å–ª–æ–≤–∞ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞.",
        
        "–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ AI —Å–∏—Å—Ç–µ–º–∞—Ö?":
            "–ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ AI —Å–∏—Å—Ç–µ–º–∞—Ö - —ç—Ç–æ —Ç–µ—Ö–Ω–∏–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≤—ã—á–∏—Å–ª–µ–Ω–∏–π –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è. –í RAG —Å–∏—Å—Ç–µ–º–∞—Ö –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–æ–≤ –Ω–∞ —á–∞—Å—Ç—ã–µ –≤–æ–ø—Ä–æ—Å—ã —Å–Ω–∏–∂–∞–µ—Ç –∑–∞—Ç—Ä–∞—Ç—ã –Ω–∞ API –∏ —É–º–µ–Ω—å—à–∞–µ—Ç latency. –°—Ç—Ä–∞—Ç–µ–≥–∏–∏ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è –≤–∫–ª—é—á–∞—é—Ç LRU (Least Recently Used), TTL (Time To Live) –∏ —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–æ–µ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ.",
        
        "–ß—Ç–æ —Ç–∞–∫–æ–µ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –≤ —è–∑—ã–∫–æ–≤—ã—Ö –º–æ–¥–µ–ª—è—Ö?":
            "–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –≤ —è–∑—ã–∫–æ–≤—ã—Ö –º–æ–¥–µ–ª—è—Ö - —ç—Ç–æ –≥–∏–ø–µ—Ä–ø–∞—Ä–∞–º–µ—Ç—Ä, –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É—é—â–∏–π —Å–ª—É—á–∞–π–Ω–æ—Å—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏. –ù–∏–∑–∫–∞—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ (0.1-0.3) –¥–µ–ª–∞–µ—Ç –æ—Ç–≤–µ—Ç—ã –±–æ–ª–µ–µ –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –∏ —Å—Ñ–æ–∫—É—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏. –í—ã—Å–æ–∫–∞—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ (0.8-1.0) —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –∫—Ä–µ–∞—Ç–∏–≤–Ω–æ—Å—Ç—å –∏ —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏–µ."
    }
    
    return ground_truth


class SimpleRAGEvaluator:
    """–ü—Ä–æ—Å—Ç–æ–π –æ—Ü–µ–Ω—â–∏–∫ RAG —Å–∏—Å—Ç–µ–º—ã –±–µ–∑ PyTorch –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π."""
    
    def __init__(self):
        """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ—Ü–µ–Ω—â–∏–∫–∞."""
        self.openai_client = OpenAI(api_key=os.getenv("OPENAI_API_KEY"))
        self.ground_truth_answers = get_ground_truth_answers()
    
    def evaluate_answer_quality(self, question: str, answer: str, context: List[str], ground_truth: str) -> Dict[str, float]:
        """
        –û—Ü–µ–Ω–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞ –æ—Ç–≤–µ—Ç–∞ —á–µ—Ä–µ–∑ OpenAI API —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º —ç—Ç–∞–ª–æ–Ω–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞.
        
        Args:
            question: –≤–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            answer: –æ—Ç–≤–µ—Ç RAG —Å–∏—Å—Ç–µ–º—ã
            context: –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ –≤–µ–∫—Ç–æ—Ä–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞
            ground_truth: —ç—Ç–∞–ª–æ–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç
            
        Returns:
            —Å–ª–æ–≤–∞—Ä—å —Å –æ—Ü–µ–Ω–∫–∞–º–∏ –∫–∞—á–µ—Å—Ç–≤–∞
        """
        # –§–æ—Ä–º–∏—Ä—É–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –æ—Ü–µ–Ω–∫–∏
        context_text = "\n\n".join(context)
        
        # –ü—Ä–æ–º–ø—Ç –¥–ª—è –æ—Ü–µ–Ω–∫–∏ –∫–∞—á–µ—Å—Ç–≤–∞ –æ—Ç–≤–µ—Ç–∞ —Å —ç—Ç–∞–ª–æ–Ω–Ω—ã–º –æ—Ç–≤–µ—Ç–æ–º
        evaluation_prompt = f"""–û—Ü–µ–Ω–∏ –∫–∞—á–µ—Å—Ç–≤–æ –æ—Ç–≤–µ—Ç–∞ RAG —Å–∏—Å—Ç–µ–º—ã –ø–æ —Å–ª–µ–¥—É—é—â–∏–º –∫—Ä–∏—Ç–µ—Ä–∏—è–º:

–í–û–ü–†–û–°: {question}

–≠–¢–ê–õ–û–ù–ù–´–ô –û–¢–í–ï–¢ (–∏–∑ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π):
{ground_truth}

–ö–û–ù–¢–ï–ö–°–¢:
{context_text}

–û–¢–í–ï–¢ RAG –°–ò–°–¢–ï–ú–´:
{answer}

–û—Ü–µ–Ω–∏ –ø–æ —à–∫–∞–ª–µ –æ—Ç 0 –¥–æ 1 (–≥–¥–µ 1 - –æ—Ç–ª–∏—á–Ω–æ, 0 - –ø–ª–æ—Ö–æ):

1. –¢–û–ß–ù–û–°–¢–¨ (Faithfulness): –ù–∞—Å–∫–æ–ª—å–∫–æ –æ—Ç–≤–µ—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–º—É –∫–æ–Ω—Ç–µ–∫—Å—Ç—É? –ù–µ—Ç –ª–∏ –≤ –æ—Ç–≤–µ—Ç–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏, –∫–æ—Ç–æ—Ä–æ–π –Ω–µ—Ç –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ?

2. –†–ï–õ–ï–í–ê–ù–¢–ù–û–°–¢–¨ (Relevance): –ù–∞—Å–∫–æ–ª—å–∫–æ –æ—Ç–≤–µ—Ç –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –∑–∞–¥–∞–Ω–Ω—ã–π –≤–æ–ø—Ä–æ—Å? –ü–æ–ª–Ω—ã–π –ª–∏ –æ—Ç–≤–µ—Ç?

3. –ö–ê–ß–ï–°–¢–í–û –ö–û–ù–¢–ï–ö–°–¢–ê (Context Quality): –ù–∞—Å–∫–æ–ª—å–∫–æ —Ö–æ—Ä–æ—à–æ –ø–æ–¥–æ–±—Ä–∞–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–º–æ–≥–∞–µ—Ç –æ—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å?

4. –Ø–°–ù–û–°–¢–¨ (Clarity): –ù–∞—Å–∫–æ–ª—å–∫–æ –ø–æ–Ω—è—Ç–Ω–æ –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ –∏–∑–ª–æ–∂–µ–Ω –æ—Ç–≤–µ—Ç?

5. –°–û–û–¢–í–ï–¢–°–¢–í–ò–ï –≠–¢–ê–õ–û–ù–£ (Ground Truth Similarity): –ù–∞—Å–∫–æ–ª—å–∫–æ –æ—Ç–≤–µ—Ç RAG —Å–∏—Å—Ç–µ–º—ã —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —ç—Ç–∞–ª–æ–Ω–Ω–æ–º—É –æ—Ç–≤–µ—Ç—É –ø–æ —Å–º—ã—Å–ª—É –∏ –ø–æ–ª–Ω–æ—Ç–µ?

–í–µ—Ä–Ω–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –¢–û–õ–¨–ö–û –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON:
{{
    "faithfulness": 0.X,
    "relevance": 0.X, 
    "context_quality": 0.X,
    "clarity": 0.X,
    "ground_truth_similarity": 0.X,
    "reasoning": "–∫—Ä–∞—Ç–∫–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ –æ—Ü–µ–Ω–æ–∫"
}}"""

        try:
            response = self.openai_client.chat.completions.create(
                model="gpt-4o-mini",
                messages=[
                    {"role": "system", "content": "–¢—ã —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –æ—Ü–µ–Ω–∫–µ –∫–∞—á–µ—Å—Ç–≤–∞ AI —Å–∏—Å—Ç–µ–º. –û—Ü–µ–Ω–∏–≤–∞–π –æ–±—ä–µ–∫—Ç–∏–≤–Ω–æ –∏ —Å—Ç—Ä–æ–≥–æ, —Å—Ä–∞–≤–Ω–∏–≤–∞—è —Å —ç—Ç–∞–ª–æ–Ω–Ω—ã–º–∏ –æ—Ç–≤–µ—Ç–∞–º–∏."},
                    {"role": "user", "content": evaluation_prompt}
                ],
                temperature=0.1,
                max_tokens=500
            )
            
            # –ü–∞—Ä—Å–∏–º JSON –æ—Ç–≤–µ—Ç
            result_text = response.choices[0].message.content.strip()
            
            # –ò–∑–≤–ª–µ–∫–∞–µ–º JSON –∏–∑ –æ—Ç–≤–µ—Ç–∞
            if "```json" in result_text:
                json_start = result_text.find("```json") + 7
                json_end = result_text.find("```", json_start)
                result_text = result_text[json_start:json_end].strip()
            elif "{" in result_text:
                json_start = result_text.find("{")
                json_end = result_text.rfind("}") + 1
                result_text = result_text[json_start:json_end]
            
            evaluation = json.loads(result_text)
            return evaluation
            
        except Exception as e:
            print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ü–µ–Ω–∫–µ: {e}")
            return {
                "faithfulness": 0.5,
                "relevance": 0.5,
                "context_quality": 0.5,
                "clarity": 0.5,
                "ground_truth_similarity": 0.5,
                "reasoning": f"–û—à–∏–±–∫–∞ –æ—Ü–µ–Ω–∫–∏: {e}"
            }
    
    def evaluate_rag_system(self, pipeline: RAGPipeline, questions: List[str]) -> Dict[str, Any]:
        """
        –ü–æ–ª–Ω–∞—è –æ—Ü–µ–Ω–∫–∞ RAG —Å–∏—Å—Ç–µ–º—ã —Å —ç—Ç–∞–ª–æ–Ω–Ω—ã–º–∏ –æ—Ç–≤–µ—Ç–∞–º–∏.
        
        Args:
            pipeline: RAG pipeline –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            questions: —Å–ø–∏—Å–æ–∫ –≤–æ–ø—Ä–æ—Å–æ–≤ –¥–ª—è –æ—Ü–µ–Ω–∫–∏
            
        Returns:
            —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ—Ü–µ–Ω–∫–∏
        """
        print(f"[*] –ù–∞—á–∏–Ω–∞–µ–º –æ—Ü–µ–Ω–∫—É RAG —Å–∏—Å—Ç–µ–º—ã –Ω–∞ {len(questions)} –≤–æ–ø—Ä–æ—Å–∞—Ö —Å —ç—Ç–∞–ª–æ–Ω–Ω—ã–º–∏ –æ—Ç–≤–µ—Ç–∞–º–∏...\n")
        
        results = []
        total_scores = {
            "faithfulness": 0,
            "relevance": 0,
            "context_quality": 0,
            "clarity": 0,
            "ground_truth_similarity": 0
        }
        
        for i, question in enumerate(questions, 1):
            print(f"  {i}/{len(questions)}: {question}")
            
            # –ü–æ–ª—É—á–∞–µ–º –æ—Ç–≤–µ—Ç –æ—Ç RAG —Å–∏—Å—Ç–µ–º—ã
            rag_result = pipeline.query(question, use_cache=False)
            
            # –ò–∑–≤–ª–µ–∫–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç
            context_texts = [doc["text"] for doc in rag_result["context_docs"]]
            
            # –ü–æ–ª—É—á–∞–µ–º —ç—Ç–∞–ª–æ–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç
            ground_truth = self.ground_truth_answers.get(question, "–≠—Ç–∞–ª–æ–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω")
            
            # –û—Ü–µ–Ω–∏–≤–∞–µ–º –∫–∞—á–µ—Å—Ç–≤–æ
            evaluation = self.evaluate_answer_quality(
                question=question,
                answer=rag_result["answer"],
                context=context_texts,
                ground_truth=ground_truth
            )
            
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
            result_item = {
                "question": question,
                "answer": rag_result["answer"],
                "ground_truth": ground_truth,
                "context_count": len(context_texts),
                "from_cache": rag_result["from_cache"],
                "evaluation": evaluation
            }
            results.append(result_item)
            
            # –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—â–∏–µ —Å—á–µ—Ç—á–∏–∫–∏
            for metric in total_scores:
                total_scores[metric] += evaluation.get(metric, 0)
            
            print(f"     [+] –û—Ü–µ–Ω–∫–∏: F={evaluation.get('faithfulness', 0):.2f}, "
                  f"R={evaluation.get('relevance', 0):.2f}, "
                  f"C={evaluation.get('context_quality', 0):.2f}, "
                  f"Cl={evaluation.get('clarity', 0):.2f}, "
                  f"GT={evaluation.get('ground_truth_similarity', 0):.2f}")
        
        # –í—ã—á–∏—Å–ª—è–µ–º —Å—Ä–µ–¥–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è
        num_questions = len(questions)
        avg_scores = {
            metric: total / num_questions 
            for metric, total in total_scores.items()
        }
        
        # –û–±—â–∏–π –±–∞–ª–ª
        overall_score = sum(avg_scores.values()) / len(avg_scores)
        
        return {
            "questions_evaluated": num_questions,
            "individual_results": results,
            "average_scores": avg_scores,
            "overall_score": overall_score
        }


def print_evaluation_results(results: Dict[str, Any]):
    """–ö—Ä–∞—Å–∏–≤—ã–π –≤—ã–≤–æ–¥ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –æ—Ü–µ–Ω–∫–∏ —Å —ç—Ç–∞–ª–æ–Ω–Ω—ã–º–∏ –æ—Ç–≤–µ—Ç–∞–º–∏."""
    
    print("\n" + "=" * 70)
    print("–†–ï–ó–£–õ–¨–¢–ê–¢–´ –û–¶–ï–ù–ö–ò RAG –°–ò–°–¢–ï–ú–´ (–° –≠–¢–ê–õ–û–ù–ù–´–ú–ò –û–¢–í–ï–¢–ê–ú–ò)")
    print("=" * 70)
    
    # –û–±—â–∏–µ –º–µ—Ç—Ä–∏–∫–∏
    avg_scores = results["average_scores"]
    overall_score = results["overall_score"]
    
    print(f"\n[–û–ë–©–ò–ï –ú–ï–¢–†–ò–ö–ò] (–æ—Ü–µ–Ω–µ–Ω–æ {results['questions_evaluated']} –≤–æ–ø—Ä–æ—Å–æ–≤):")
    print(f"   –¢–æ—á–Ω–æ—Å—Ç—å (Faithfulness):           {avg_scores['faithfulness']:.3f}")
    print(f"   –†–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å (Relevance):         {avg_scores['relevance']:.3f}")
    print(f"   –ö–∞—á–µ—Å—Ç–≤–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞:                {avg_scores['context_quality']:.3f}")
    print(f"   –Ø—Å–Ω–æ—Å—Ç—å –∏–∑–ª–æ–∂–µ–Ω–∏—è:                 {avg_scores['clarity']:.3f}")
    print(f"   –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —ç—Ç–∞–ª–æ–Ω—É:              {avg_scores['ground_truth_similarity']:.3f}")
    
    print(f"\n{'‚îÄ'*70}")
    print(f"[–ò–¢–û–ì–û–í–´–ô –ë–ê–õ–õ]: {overall_score:.3f}")
    
    # –û—Ü–µ–Ω–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞
    if overall_score >= 0.8:
        print("   üü¢ –û—Ç–ª–∏—á–Ω–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ! –°–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–µ–≤–æ—Å—Ö–æ–¥–Ω–æ.")
    elif overall_score >= 0.7:
        print("   üü° –•–æ—Ä–æ—à–µ–µ –∫–∞—á–µ—Å—Ç–≤–æ. –ï—Å—Ç—å –º–µ—Å—Ç–æ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏–π.")
    elif overall_score >= 0.6:
        print("   üü† –£–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–∏—Ç–µ–ª—å–Ω–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ. –†–µ–∫–æ–º–µ–Ω–¥—É—é—Ç—Å—è —É–ª—É—á—à–µ–Ω–∏—è.")
    else:
        print("   üî¥ –¢—Ä–µ–±—É–µ—Ç –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ–≥–æ —É–ª—É—á—à–µ–Ω–∏—è.")
    
    # –î–µ—Ç–∞–ª—å–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
    print("\n" + "=" * 70)
    print("–î–ï–¢–ê–õ–¨–ù–´–ï –†–ï–ó–£–õ–¨–¢–ê–¢–´ –ü–û –í–û–ü–†–û–°–ê–ú")
    print("=" * 70)
    
    for i, result in enumerate(results["individual_results"], 1):
        eval_data = result["evaluation"]
        
        print(f"\n{i}. {result['question']}")
        print(f"   –ö–æ–Ω—Ç–µ–∫—Å—Ç: {result['context_count']} –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤")
        print(f"   –ò–∑ –∫–µ—à–∞: {'–î–∞' if result['from_cache'] else '–ù–µ—Ç'}")
        print(f"   –û—Ü–µ–Ω–∫–∏: F={eval_data.get('faithfulness', 0):.2f} | "
              f"R={eval_data.get('relevance', 0):.2f} | "
              f"C={eval_data.get('context_quality', 0):.2f} | "
              f"Cl={eval_data.get('clarity', 0):.2f} | "
              f"GT={eval_data.get('ground_truth_similarity', 0):.2f}")
        
        if "reasoning" in eval_data:
            print(f"   –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: {eval_data['reasoning']}")
    
    # –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
    print("\n" + "=" * 70)
    print("–†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò –ü–û –£–õ–£–ß–®–ï–ù–ò–Æ")
    print("=" * 70)
    
    if avg_scores['faithfulness'] < 0.7:
        print("‚Ä¢ –¢–æ—á–Ω–æ—Å—Ç—å: –£–ª—É—á—à–∏—Ç–µ –∫–∞—á–µ—Å—Ç–≤–æ chunking –∏–ª–∏ –¥–æ–±–∞–≤—å—Ç–µ –±–æ–ª—å—à–µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤")
    
    if avg_scores['relevance'] < 0.7:
        print("‚Ä¢ –†–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å: –û–ø—Ç–∏–º–∏–∑–∏—Ä—É–π—Ç–µ –ø—Ä–æ–º–ø—Ç—ã –∏–ª–∏ —É–ª—É—á—à–∏—Ç–µ –∞–ª–≥–æ—Ä–∏—Ç–º –ø–æ–∏—Å–∫–∞")
    
    if avg_scores['context_quality'] < 0.7:
        print("‚Ä¢ –ö–æ–Ω—Ç–µ–∫—Å—Ç: –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≤–µ–∫—Ç–æ—Ä–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞ (top_k, similarity threshold)")
    
    if avg_scores['clarity'] < 0.7:
        print("‚Ä¢ –Ø—Å–Ω–æ—Å—Ç—å: –£–ª—É—á—à–∏—Ç–µ –ø—Ä–æ–º–ø—Ç—ã –¥–ª—è –±–æ–ª–µ–µ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤")
    
    if avg_scores['ground_truth_similarity'] < 0.7:
        print("‚Ä¢ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —ç—Ç–∞–ª–æ–Ω—É: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–∞—á–µ—Å—Ç–≤–æ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –º–æ–¥–µ–ª–∏")
    
    print("\n" + "=" * 70)


def main():
    """–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ—Ü–µ–Ω–∫–∏."""
    print("=" * 70)
    print("–ü–†–û–°–¢–ê–Ø –û–¶–ï–ù–ö–ê –ö–ê–ß–ï–°–¢–í–ê RAG –°–ò–°–¢–ï–ú–´ –° –≠–¢–ê–õ–û–ù–ù–´–ú–ò –û–¢–í–ï–¢–ê–ú–ò")
    print("=" * 70)
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ API –∫–ª—é—á–∞
    if not os.getenv("OPENAI_API_KEY"):
        print("[–û–®–ò–ë–ö–ê] OPENAI_API_KEY –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")
        print("\n–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª .env")
        sys.exit(1)
    
    try:
        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è RAG —Å–∏—Å—Ç–µ–º—ã
        print("[*] –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è RAG —Å–∏—Å—Ç–µ–º—ã...")
        with RAGPipeline(
            collection_name="api_rag_collection",
            cache_db_path="api_rag_cache.db", 
            data_file="data/docs.txt",
            model="gpt-4o-mini"
        ) as pipeline:
            print("[‚úì] RAG —Å–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞")
            
            # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ—Ü–µ–Ω—â–∏–∫–∞
            evaluator = SimpleRAGEvaluator()
            
            # –ó–∞–ø—É—Å–∫ –æ—Ü–µ–Ω–∫–∏
            results = evaluator.evaluate_rag_system(pipeline, EVALUATION_QUESTIONS)
            
            # –í—ã–≤–æ–¥ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
            print_evaluation_results(results)
            
            # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≤ —Ñ–∞–π–ª
            output_file = "evaluation_results_with_ground_truth.json"
            with open(output_file, 'w', encoding='utf-8') as f:
                json.dump(results, f, ensure_ascii=False, indent=2)
            
            print(f"\n[‚úì] –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ {output_file}")
        
        print("\n[‚úì] –û—Ü–µ–Ω–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!")
        
    except Exception as e:
        print(f"[–û–®–ò–ë–ö–ê] {e}")
        sys.exit(1)


if __name__ == "__main__":
    main()